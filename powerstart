#!/bin/bash

# powerstart - Start all reactive-platform services
# A simple way to bring up the entire platform for local development

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# Get the directory where this script lives
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DOCKER_DIR="$SCRIPT_DIR/docker"

# Track what we started
declare -a STARTED_SERVICES=()
declare -a FAILED_SERVICES=()

# Logging functions
log_header() {
    echo ""
    echo -e "${BOLD}${BLUE}══════════════════════════════════════════════════════════════${NC}"
    echo -e "${BOLD}${BLUE}  $1${NC}"
    echo -e "${BOLD}${BLUE}══════════════════════════════════════════════════════════════${NC}"
}

log_step() {
    echo -e "${CYAN}▶${NC} $1"
}

log_success() {
    echo -e "${GREEN}✓${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}⚠${NC} $1"
}

log_error() {
    echo -e "${RED}✗${NC} $1"
}

log_info() {
    echo -e "${BLUE}ℹ${NC} $1"
}

# Check prerequisites
check_prerequisites() {
    log_header "Checking Prerequisites"

    # Check Docker
    if ! command -v docker &> /dev/null; then
        log_error "Docker is not installed or not in PATH"
        exit 1
    fi
    log_success "Docker is available"

    # Check Docker is running
    if ! docker info &> /dev/null; then
        log_error "Docker daemon is not running"
        exit 1
    fi
    log_success "Docker daemon is running"

    # Check docker compose
    if ! docker compose version &> /dev/null; then
        log_error "Docker Compose is not available"
        exit 1
    fi
    log_success "Docker Compose is available"

    # Check if docker-compose.yml exists
    if [ ! -f "$DOCKER_DIR/docker-compose.yml" ]; then
        log_error "docker-compose.yml not found in $DOCKER_DIR"
        exit 1
    fi
    log_success "docker-compose.yml found"
}

# Build JARs if needed
build_jars() {
    log_header "Building Application JARs"

    log_step "Building bootJars for all services..."
    log_info "This may take a few minutes on first run"

    cd "$SCRIPT_DIR"

    if ./gradlew bootJar --parallel -q 2>&1; then
        log_success "All JARs built successfully"
    else
        log_error "JAR build failed"
        exit 1
    fi
}

# Start infrastructure services
start_infrastructure() {
    log_header "Starting Infrastructure Services"

    cd "$DOCKER_DIR"

    log_step "Starting PostgreSQL, Redis, and WireMock..."
    if docker compose up -d postgres redis wiremock 2>&1 | grep -v "^$"; then
        log_success "Infrastructure containers started"
    else
        log_warning "Some infrastructure services may have issues"
    fi

    log_step "Waiting for infrastructure to be healthy..."

    # Wait for postgres
    local retries=30
    while [ $retries -gt 0 ]; do
        if docker compose exec -T postgres pg_isready -U postgres &> /dev/null; then
            log_success "PostgreSQL is ready"
            STARTED_SERVICES+=("postgres:5432")
            break
        fi
        retries=$((retries - 1))
        sleep 1
    done
    if [ $retries -eq 0 ]; then
        log_error "PostgreSQL failed to start"
        FAILED_SERVICES+=("postgres")
    fi

    # Wait for redis
    retries=30
    while [ $retries -gt 0 ]; do
        if docker compose exec -T redis redis-cli ping &> /dev/null; then
            log_success "Redis is ready"
            STARTED_SERVICES+=("redis:6379")
            break
        fi
        retries=$((retries - 1))
        sleep 1
    done
    if [ $retries -eq 0 ]; then
        log_error "Redis failed to start"
        FAILED_SERVICES+=("redis")
    fi

    # Wait for wiremock
    retries=30
    while [ $retries -gt 0 ]; do
        if curl -sf http://localhost:8082/__admin/mappings &> /dev/null; then
            log_success "WireMock is ready"
            STARTED_SERVICES+=("wiremock:8082")
            break
        fi
        retries=$((retries - 1))
        sleep 1
    done
    if [ $retries -eq 0 ]; then
        log_error "WireMock failed to start"
        FAILED_SERVICES+=("wiremock")
    fi
}

# Start observability stack
start_observability() {
    log_header "Starting Observability Stack"

    cd "$DOCKER_DIR"

    log_step "Starting Tempo, Loki, Prometheus, and Grafana..."
    if docker compose up -d tempo loki prometheus grafana promtail redis-exporter 2>&1 | grep -v "^$"; then
        log_success "Observability containers started"
    else
        log_warning "Some observability services may have issues"
    fi

    log_step "Waiting for observability stack to be healthy..."

    # Wait for grafana (it depends on the others)
    local retries=60
    while [ $retries -gt 0 ]; do
        if curl -sf http://localhost:3000/api/health &> /dev/null; then
            log_success "Grafana is ready"
            STARTED_SERVICES+=("grafana:3000")
            STARTED_SERVICES+=("prometheus:9090")
            STARTED_SERVICES+=("loki:3100")
            STARTED_SERVICES+=("tempo:3200")
            break
        fi
        retries=$((retries - 1))
        sleep 2
    done
    if [ $retries -eq 0 ]; then
        log_warning "Grafana may not be fully ready yet"
    fi
}

# Start backend services
start_backend_services() {
    log_header "Starting Backend Services"

    cd "$DOCKER_DIR"

    # Start services in dependency order
    local services=(
        "product-service:8080"
        "customer-service:8083"
        "discount-service:8084"
        "fulfillment-service:8085"
        "audit-service:8086"
        "cart-service:8081"
        "checkout-service:8087"
        "order-service:8088"
    )

    log_step "Starting all backend services..."
    docker compose up -d \
        product-service \
        customer-service \
        discount-service \
        fulfillment-service \
        audit-service \
        cart-service \
        checkout-service \
        order-service 2>&1 | grep -v "^$" || true

    log_step "Waiting for backend services to be healthy (this may take 1-2 minutes)..."

    for service_port in "${services[@]}"; do
        local service="${service_port%%:*}"
        local port="${service_port##*:}"
        local retries=90

        echo -n "  Waiting for $service..."
        while [ $retries -gt 0 ]; do
            if curl -sf "http://localhost:$port/actuator/health" &> /dev/null; then
                echo -e " ${GREEN}✓${NC}"
                STARTED_SERVICES+=("$service:$port")
                break
            fi
            retries=$((retries - 1))
            sleep 2
        done
        if [ $retries -eq 0 ]; then
            echo -e " ${RED}✗${NC}"
            FAILED_SERVICES+=("$service")
        fi
    done
}

# Start frontend
start_frontend() {
    log_header "Starting Frontend Application"

    cd "$DOCKER_DIR"

    log_step "Starting ecommerce-web..."
    if docker compose up -d ecommerce-web 2>&1 | grep -v "^$"; then
        log_success "Frontend container started"
    else
        log_warning "Frontend may have issues starting"
    fi

    log_step "Waiting for frontend to be healthy..."
    local retries=60
    while [ $retries -gt 0 ]; do
        if curl -sf http://localhost:3001/health &> /dev/null || curl -sf http://localhost:3001 &> /dev/null; then
            log_success "Frontend is ready"
            STARTED_SERVICES+=("ecommerce-web:3001")
            break
        fi
        retries=$((retries - 1))
        sleep 2
    done
    if [ $retries -eq 0 ]; then
        log_warning "Frontend may not be fully ready yet"
        STARTED_SERVICES+=("ecommerce-web:3001")  # Add anyway, might just be slow
    fi
}

# Print summary
print_summary() {
    log_header "Startup Summary"

    if [ ${#FAILED_SERVICES[@]} -gt 0 ]; then
        echo -e "${RED}Some services failed to start:${NC}"
        for service in "${FAILED_SERVICES[@]}"; do
            echo -e "  ${RED}✗${NC} $service"
        done
        echo ""
    fi

    echo -e "${GREEN}${BOLD}Services Running:${NC}"
    echo ""

    # Infrastructure
    echo -e "${BOLD}Infrastructure:${NC}"
    echo -e "  ${CYAN}PostgreSQL${NC}        http://localhost:5432"
    echo -e "                     Connect with: psql -h localhost -U postgres -d postgres"
    echo ""
    echo -e "  ${CYAN}Redis${NC}             http://localhost:6379"
    echo -e "                     Connect with: redis-cli -h localhost"
    echo ""
    echo -e "  ${CYAN}WireMock${NC}          http://localhost:8082"
    echo -e "                     View mappings at: http://localhost:8082/__admin/mappings"
    echo ""

    # Observability
    echo -e "${BOLD}Observability:${NC}"
    echo -e "  ${CYAN}Grafana${NC}           http://localhost:3000"
    echo -e "                     Login with admin/admin to view dashboards and explore metrics."
    echo ""
    echo -e "  ${CYAN}Prometheus${NC}        http://localhost:9090"
    echo -e "                     Query metrics directly using PromQL expressions."
    echo ""
    echo -e "  ${CYAN}Loki${NC}              http://localhost:3100"
    echo -e "                     Query logs via Grafana Explore with LogQL."
    echo ""
    echo -e "  ${CYAN}Tempo${NC}             http://localhost:3200"
    echo -e "                     View distributed traces via Grafana Explore."
    echo ""

    # Backend Services
    echo -e "${BOLD}Backend Services:${NC}"
    echo -e "  ${CYAN}product-service${NC}   http://localhost:8080"
    echo -e "                     GET /products/{sku} with headers x-store-number, x-order-number, x-userid, x-sessionid."
    echo ""
    echo -e "  ${CYAN}cart-service${NC}      http://localhost:8081"
    echo -e "                     POST /carts to create a cart, GET /carts/{id} to retrieve."
    echo ""
    echo -e "  ${CYAN}customer-service${NC}  http://localhost:8083"
    echo -e "                     GET /customers/{id} to fetch customer details and loyalty info."
    echo ""
    echo -e "  ${CYAN}discount-service${NC}  http://localhost:8084"
    echo -e "                     POST /pricing/calculate to compute discounts for cart items."
    echo ""
    echo -e "  ${CYAN}fulfillment-service${NC} http://localhost:8085"
    echo -e "                     GET /fulfillment/options to retrieve shipping and pickup options."
    echo ""
    echo -e "  ${CYAN}audit-service${NC}     http://localhost:8086"
    echo -e "                     GET /audit/events to query audit trail with filters."
    echo ""
    echo -e "  ${CYAN}checkout-service${NC}  http://localhost:8087"
    echo -e "                     POST /checkout to initiate order checkout from cart."
    echo ""
    echo -e "  ${CYAN}order-service${NC}     http://localhost:8088"
    echo -e "                     GET /orders/{id} for REST or POST /graphql for GraphQL queries."
    echo ""

    # Frontend
    echo -e "${BOLD}Frontend:${NC}"
    echo -e "  ${CYAN}ecommerce-web${NC}     http://localhost:3001"
    echo -e "                     Browse products and add to cart in the web UI."
    echo ""

    # Quick test commands
    echo -e "${BOLD}${YELLOW}Quick Test Commands:${NC}"
    echo ""
    echo -e "  # Health check all services"
    echo -e "  curl -s http://localhost:8080/actuator/health | jq"
    echo ""
    echo -e "  # Get a product"
    echo -e "  curl -s http://localhost:8080/products/SKU-001 \\"
    echo -e "    -H 'x-store-number: 1' \\"
    echo -e "    -H 'x-order-number: 550e8400-e29b-41d4-a716-446655440000' \\"
    echo -e "    -H 'x-userid: abc123' \\"
    echo -e "    -H 'x-sessionid: 550e8400-e29b-41d4-a716-446655440001' | jq"
    echo ""
    echo -e "  # View logs"
    echo -e "  docker compose -f docker/docker-compose.yml logs -f product-service"
    echo ""
    echo -e "  # Stop everything"
    echo -e "  docker compose -f docker/docker-compose.yml down"
    echo ""

    echo -e "${GREEN}${BOLD}Platform is ready!${NC} Open ${CYAN}http://localhost:3001${NC} to start."
}

# Main execution
main() {
    echo -e "${BOLD}"
    echo "  ____                          ____  _             _   "
    echo " |  _ \\ _____      _____ _ __  / ___|| |_ __ _ _ __| |_ "
    echo " | |_) / _ \\ \\ /\\ / / _ \\ '__| \\___ \\| __/ _\` | '__| __|"
    echo " |  __/ (_) \\ V  V /  __/ |     ___) | || (_| | |  | |_ "
    echo " |_|   \\___/ \\_/\\_/ \\___|_|    |____/ \\__\\__,_|_|   \\__|"
    echo -e "${NC}"
    echo -e "${BLUE}Starting the Reactive Platform...${NC}"

    check_prerequisites
    build_jars
    start_infrastructure
    start_observability
    start_backend_services
    start_frontend
    print_summary
}

# Handle Ctrl+C gracefully
trap 'echo -e "\n${YELLOW}Interrupted. Services may still be running.${NC}"; exit 1' INT

# Run main
main "$@"
